Create a pull request with Linear integration and automatic cleanup.

## Usage

```
/create-pr
/create-pr {{formats.issueExample}}
/create-pr --no-cleanup
```

## Description

Creates a comprehensive pull request with automatic Linear integration. The PR includes a summary of changes, links to Linear issues, testing notes, and a review checklist.

**NEW:** Automatically offers to clean up merged branches after PR is merged!

## Workflow

### Step 1: Detect Current Issue

If you're on a feature branch, Claude automatically detects the issue:
```
Current branch: feature/{{formats.issueExample}}-user-auth
Detected issue: {{formats.issueExample}}
```

If not on a feature branch or issue can't be detected:
```
Which issue is this PR for?
Issue ID: _____
```

### Step 2: Check for Uncommitted Changes

```
Found uncommitted changes:
  M  src/auth/login.ts
  M  tests/auth.test.ts

Commit these changes? (Y/n)
```

If yes, creates a commit with proper format.

### Step 3: Determine Target Branch

```
Where should this PR merge to?

1. {{branches.main}} (development) [Default]
{{#if branches.staging}}2. {{branches.staging}} (staging/QA){{/if}}
{{#if branches.prod}}3. {{branches.prod}} (production){{/if}}
4. Custom branch

Your choice [1]: _____
```

**Special detection:** If target is production, offers to create release approval issue.

### Step 4: Generate PR Description

Claude analyzes your commits and generates a comprehensive PR description:

```markdown
## ğŸ¯ Summary
Implements user authentication with OAuth 2.0 support for Google and GitHub providers.

Closes: {{formats.issueExample}}

## ğŸ“ Changes
### Added
- OAuth 2.0 login flow (Google, GitHub)
- JWT token generation and validation
- User session management

### Modified
- Updated User model with OAuth fields
- Enhanced API middleware for auth checks

## ğŸ§ª Testing
- âœ… Unit tests: 15 new tests, all passing
- âœ… Integration tests: OAuth flow tested end-to-end

## ğŸ” Code Review Focus
- Security: JWT implementation and secret management
- Error handling: OAuth failure scenarios

## âœ… Checklist
- [x] Tests passing
- [x] Linting passing
- [x] Documentation updated
- [ ] Ready for review
```

### Step 5: Create PR

```
Creating pull request...

âœ“ PR created: #234
  Title: {{formats.issueExample}}: Add user authentication
  URL: https://github.com/{{owner}}/{{repo}}/pull/234

Would you like me to post a summary comment to Linear? (Y/n)
```

If yes, posts PR link and summary to Linear issue.

### Step 6: Status Update

If GitHub Actions is enabled, status updates automatically when PR is merged.

If GitHub Actions is disabled:
```
PR merged! Would you like me to update the Linear status? (Y/n)
```

### Step 7: Branch Cleanup (NEW!)

After PR is successfully merged:

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… PR #234 merged successfully!

Issue {{formats.issueExample}} status â†’ "{{linear.statuses.review}}"

Branch Cleanup:
  Local:  feature/{{formats.issueExample}}-user-auth
  Remote: origin/feature/{{formats.issueExample}}-user-auth

These branches are no longer needed. Delete them? (Y/n)
```

**If yes:**
```
Cleaning up branches...

  âœ“ Switched to {{branches.main}}
  âœ“ Deleted local branch: feature/{{formats.issueExample}}-user-auth
  âœ“ Deleted remote branch: origin/feature/{{formats.issueExample}}-user-auth

âœ“ Cleanup complete! Workspace is clean.
```

**If no:**
```
Branches kept. You can clean up later with:
  /cleanup-branches
```

**Safety check:** Won't delete if branch has unpushed commits or unmerged changes.

## Examples

### Example 1: Simple PR

```
You: "/create-pr"

Claude: "Current issue: {{formats.issueExample}}"
        "No uncommitted changes"
        "Target branch: {{branches.main}}"

        [Generates PR description]

        "Creating PR..."

        âœ“ PR #234 created
        "Post summary to Linear? (Y/n)"

You: "y"

Claude: âœ“ Posted to Linear

        "PR created successfully!"
```

### Example 2: PR with Uncommitted Changes

```
You: "/create-pr"

Claude: "Found uncommitted changes. Commit? (Y/n)"

You: "y"

Claude: "Commit message: 'feat: Complete authentication flow ({{formats.issueReferenceKeyword}}: {{formats.issueExample}})'"

        âœ“ Changes committed
        âœ“ PR #235 created
```

### Example 3: Production Release with Cleanup

```
You: "/create-pr"

Claude: "Target branch: {{branches.prod}} (production)"

        "This looks like a release PR!"
        "Create a Release Approval issue? (Y/n)"

You: "y"

Claude: [Creates release approval {{formats.issueExample}}-RELEASE]

        âœ“ PR #236 created
        âœ“ Release approval linked

[After PR merges]

Claude: "âœ… PR merged to production!"

        "Delete feature branch? (Y/n)"

You: "y"

Claude: âœ“ Branches cleaned up
        âœ“ Ready for next issue!
```

### Example 4: Skip Auto-Cleanup

```
You: "/create-pr --no-cleanup"

Claude: [Creates PR normally]

        "âœ“ PR #237 created"

        [No cleanup prompt after merge]
```

## Smart Features

### 1. Auto-Detection
- Detects current issue from branch name
- Identifies target branch from workflow
- Recognizes production releases
- Finds related PRs automatically

### 2. Comprehensive PR Descriptions
- Analyzes all commits since branch creation
- Categorizes changes (Added/Modified/Removed)
- Extracts test information
- Includes Linear issue context
- Suggests review focus areas

### 3. Safety Checks
- Won't delete branches with unpushed commits
- Confirms before destructive operations
- Validates issue exists in Linear
- Checks for merge conflicts

### 4. Integration
- Posts to Linear automatically
- Triggers GitHub Actions (if enabled)
- Updates issue status
- Links related issues
- Creates release approvals for production

## Configuration

Uses your workflow configuration:

- **Target Branch**: {{branches.main}} (default)
- **PR Format**: {{formats.pr}}
- **Issue Reference**: {{formats.issueReferenceKeyword}}
- **Auto-Cleanup**: Enabled by default

### Disable Auto-Cleanup

Add to `.linear-workflow.json`:
```json
{
  "prSettings": {
    "autoCleanup": false
  }
}
```

Or use `--no-cleanup` flag each time.

## Related Commands

- `/start-issue` - Start work on an issue
- `/progress-update` - Post progress before creating PR
- `/cleanup-branches` - Manually clean up old branches
- `/create-release-approval` - Create production release approval

## Troubleshooting

### PR Creation Fails

**Error:** "No commits to create PR"

**Fix:** Make sure you have commits on your branch:
```bash
git log {{branches.main}}..HEAD
```

**Error:** "Branch already has open PR"

**Fix:** Check existing PRs:
```bash
gh pr list --head $(git branch --show-current)
```

### Branch Cleanup Fails

**Error:** "Cannot delete branch with unpushed commits"

**Fix:** Push your commits first:
```bash
git push origin HEAD
```

**Error:** "Branch not fully merged"

**Fix:** Ensure PR was merged successfully. If intentionally abandoning:
```bash
git branch -D branch-name
```

### Linear Update Fails

**Error:** "Could not post to Linear"

**Fix:** Check MCP connection:
```
/workflow-status
```

Then retry posting manually.

## Tips

1. **Commit before creating PR** - Cleaner git history
2. **Use descriptive commit messages** - Better PR descriptions
3. **Review generated description** - Claude asks before creating
4. **Let cleanup happen** - Keeps repository tidy
5. **Create release approvals** - For production deployments

## Best Practices

### PR Size
- Keep PRs focused and small
- One issue per PR (usually)
- Split large features into sub-tasks

### PR Description
- Let Claude generate comprehensive descriptions
- Review and edit if needed
- Include screenshots for UI changes
- Highlight breaking changes

### Branch Cleanup
- Accept cleanup prompts to keep workspace tidy
- Don't delete if you might need to reference later
- Safe to delete after PR is merged

### Review Process
- Tag reviewers in PR
- Respond to feedback promptly
- Mark conversations as resolved
- Keep Linear issue updated

---

Generated with [Claude Code](https://claude.com/claude-code)
