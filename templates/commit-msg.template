#!/bin/bash
#
# Git commit-msg hook for Linear workflow integration
# Validates commit messages contain Linear issue IDs
#
# This hook is installed by the Linear workflow setup wizard and
# ensures all commits reference a Linear issue for automatic status updates.
#
# Configuration loaded from: .linear-workflow.json
#
# To bypass this hook (not recommended):
#   git commit --no-verify -m "your message"
#

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get the commit message file
COMMIT_MSG_FILE=$1

# Read the commit message
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Load configuration from .linear-workflow.json
CONFIG_FILE=".linear-workflow.json"

if [ ! -f "$CONFIG_FILE" ]; then
    echo -e "${RED}✗ Error: .linear-workflow.json not found${NC}"
    echo ""
    echo "This hook requires Linear workflow configuration."
    echo "Run the setup wizard to configure: /setup-linear"
    echo ""
    exit 1
fi

# Extract issue pattern from config using basic tools (no jq dependency)
# Pattern: "issuePattern": "{{formats.issuePattern}}"
ISSUE_PATTERN="{{formats.issuePattern}}"
ISSUE_EXAMPLE="{{formats.issueExample}}"
COMMIT_FORMAT="{{formats.commit}}"

# Function to check if commit message contains issue ID
check_issue_id() {
    local message="$1"

    # Use grep with extended regex to check for pattern
    # The pattern needs to be converted from JSON regex to grep regex
    # Replace \d+ with [0-9]+
    local grep_pattern=$(echo "$ISSUE_PATTERN" | sed 's/\\d+/[0-9]+/g')

    if echo "$message" | grep -qE "$grep_pattern"; then
        return 0  # Success - issue ID found
    else
        return 1  # Failure - no issue ID
    fi
}

# Function to extract issue ID from message
extract_issue_id() {
    local message="$1"
    local grep_pattern=$(echo "$ISSUE_PATTERN" | sed 's/\\d+/[0-9]+/g')

    echo "$message" | grep -oE "$grep_pattern" | head -1
}

# Skip validation for certain commit types
# - Merge commits (start with "Merge")
# - Revert commits (start with "Revert")
# - Fixup/squash commits (start with "fixup!" or "squash!")
if echo "$COMMIT_MSG" | grep -qE "^(Merge|Revert|fixup!|squash!)"; then
    exit 0
fi

# Check if this is an empty commit message (will be rejected by git anyway)
if [ -z "$COMMIT_MSG" ] || [ "$COMMIT_MSG" = "" ]; then
    exit 0
fi

# Validate commit message contains issue ID
if check_issue_id "$COMMIT_MSG"; then
    ISSUE_ID=$(extract_issue_id "$COMMIT_MSG")
    echo -e "${GREEN}✓ Valid commit message${NC}"
    echo -e "  Issue: ${BLUE}$ISSUE_ID${NC}"
    exit 0
else
    # Validation failed - show helpful error message
    echo ""
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}✗ Invalid commit message format${NC}"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo "Your commit message:"
    echo -e "  ${YELLOW}$COMMIT_MSG${NC}"
    echo ""
    echo "Missing Linear issue ID!"
    echo ""
    echo "Commit messages must include a Linear issue reference"
    echo "for automatic status updates in your workflow."
    echo ""
    echo -e "${BLUE}Expected format:${NC}"

    # Show format based on configured commit style
    case "$COMMIT_FORMAT" in
        "conventional-parens")
            echo "  feat: Add user authentication ($ISSUE_EXAMPLE)"
            echo "  fix: Resolve login bug ($ISSUE_EXAMPLE)"
            echo "  docs: Update API documentation ($ISSUE_EXAMPLE)"
            ;;
        "issue-prefix")
            echo "  $ISSUE_EXAMPLE: Add user authentication"
            echo "  $ISSUE_EXAMPLE: Resolve login bug"
            echo "  $ISSUE_EXAMPLE: Update API documentation"
            ;;
        "issue-scope")
            echo "  feat($ISSUE_EXAMPLE): Add user authentication"
            echo "  fix($ISSUE_EXAMPLE): Resolve login bug"
            echo "  docs($ISSUE_EXAMPLE): Update API documentation"
            ;;
        *)
            echo "  <type>: <description> ($ISSUE_EXAMPLE)"
            echo "  $ISSUE_EXAMPLE: <description>"
            ;;
    esac

    echo ""
    echo -e "${BLUE}Valid issue ID pattern:${NC} $ISSUE_PATTERN"
    echo -e "${BLUE}Example:${NC} $ISSUE_EXAMPLE"
    echo ""
    echo "Why this matters:"
    echo "  • Links commit to Linear issue automatically"
    echo "  • Updates issue status based on branch activity"
    echo "  • Enables automatic issue tracking in PRs"
    echo ""
    echo "To fix:"
    echo "  1. Amend your commit: git commit --amend"
    echo "  2. Add issue ID to the message"
    echo "  3. Save and exit"
    echo ""
    echo "To bypass (not recommended):"
    echo "  git commit --no-verify -m \"your message\""
    echo ""
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    exit 1
fi
